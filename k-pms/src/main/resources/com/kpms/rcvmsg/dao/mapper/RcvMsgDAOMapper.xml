<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="RcvMsg">

	<resultMap id="rcvMsgVOMap"
			   type="com.kpms.rcvmsg.vo.RcvMsgVO"
			   autoMapping="true">
			<id property="msgId" column="MSG_ID"/>
			<association property="sndMsgVO"
		   				javaType="com.kpms.sndmsg.vo.SndMsgVO">
				<id property="msgId" column="SND_MSG_ID"/>
			   	<result property="ttl" column="TTL"/>
				<association property="sndEmpVO"
			 			  javaType="com.kpms.emp.vo.EmpVO">
				 	<id property="empId" column="EMP_ID"/>
				 	<result property="fNm" column="SE_F_NM"/>
				 	<result property="lNm" column="SE_L_NM"/>
				</association>
			</association>
			<association property="rcvrEmpVO"
		 			  javaType="com.kpms.emp.vo.EmpVO">
			 	<id property="empId" column="EMP_ID"/>
			 	<result property="fNm" column="RE_F_NM"/>
			 	<result property="lNm" column="RE_L_NM"/>
			</association>
	</resultMap>
	
	<select id="readAllRcvMsgVO"
			parameterType="com.kpms.rcvmsg.vo.MsgSearchVO"
			resultMap="rcvMsgVOMap">
		<include refid="Common.pageHeader"/>
		SELECT RM.MSG_ID PK_COL
			 , DENSE_RANK() OVER(ORDER BY RM.CRT_DT || RM.MSG_ID DESC) RNUM
			 , RM.MSG_ID
			 , RM.CRT_DT
			 , RM.CRTR
			 , RM.USE_YN
			 , RM.DEL_YN
			 , RM.SND_MSG_ID
			 , RM.RCVR
			 , RM.RD_YN
			 , SM.TTL
			 , SND_E.F_NM  SE_F_NM 
			 , SND_E.L_NM  SE_L_NM
		  FROM (SELECT *
		  		  FROM RCV_MSG
				 WHERE RCVR = #{empId}
				   AND DEL_YN = 'N') RM
		 INNER JOIN SND_MSG SM
		    ON SM.MSG_ID = RM.SND_MSG_ID
		 INNER JOIN (SELECT E.*
		 				  , E.L_NM || E.F_NM NM
		               FROM EMP E
					<if test='searchType == "id"'>
					   WHERE E.EMP_ID LIKE '%' || #{searchKeyword} || '%'
					</if>) SND_E
		 	ON SND_E.EMP_ID = SM.CRTR
        <if test='searchType == "sndrNm"'>
		 WHERE SND_E.NM LIKE '%' || #{searchKeyword} || '%'
		</if>
		<include refid="Common.pageFooter"/>
	</select>
	
	<select id="readOneSndMsgVO"
			parameterType="com.kpms.rcvmsg.vo.RcvMsgVO"
			resultType="com.kpms.rcvmsg.vo.RcvMsgVO">
		SELECT MSG_ID
			 , CRT_DT
			 , CRTR
			 , USE_YN
			 , DEL_YN
			 , SND_MSG_ID
			 , RCVR
			 , RD_YN
		  FROM RCV_MSG
		
	</select>
	
	<insert id="createOneRcvMsg"
			parameterType="com.kpms.rcvmsg.vo.RcvMsgVO">
		INSERT INTO RCV_MSG
				   (MSG_ID
				  , CRT_DT
				  , CRTR
				  , MDFY_DT
				  , MDFYR
				  , USE_YN
				  , DEL_YN
				  , SND_MSG_ID
				  , RCVR
				  , RD_YN)
			 VALUES
			 	  (SEQ_RCV_MSG_PK.NEXTVAL
			 	 , SYSDATE
			 	 , #{crtr}
			 	 , SYSDATE
			 	 , #{mdfyr}
			 	 , NVL(#{useYn}, 'N')
			 	 , 'N'
			 	 , #{sndMsgId}
			 	 , #{rcvr}
			 	 , 'N')
	</insert>
	<insert id="createRcvMsg"
			parameterType="com.kpms.sndmsg.vo.SndMsgVO">
		INSERT INTO RCV_MSG
		 (MSG_ID
		, CRT_DT
		, CRTR
		, USE_YN
		, DEL_YN
		, SND_MSG_ID
		, RCVR
		, RD_YN)
		SELECT SEQ_RCV_MSG_PK.NEXTVAL
			 , SYSDATE
			 , #{crtr}
			 , 'Y'
			 , 'N'
			 , #{msgId}
			 , EMP_ID RCVR
			 , 'N'
		  FROM EMP
		 WHERE EMP_ID IN
		<foreach collection="rcvMsgVO" item="rcvMsg" open="(" close=")" separator=", ">
		 #{rcvMsg.rcvr}
		</foreach>
	</insert>
	
	<update id="deleteOneRcvMsg"
			parameterType="_int">
		UPDATE RCV_MSG
		   SET DEL_YN = 'Y'
		 WHERE MSG_ID = #{_parameter}
	</update>
	
	<update id="deleteRcvMsgBySelectedMsgId"
			parameterType="arraylist">
		UPDATE RCV_MSG
		   SET DEL_YN = 'Y'
		 WHERE MSG_ID IN
		 <foreach collection="list" item="msgId" open="(" close=")" separator="," >
		  #{msgId}
		 </foreach>
	</update>
	
	<update id="updateRcvMsgReadByRcvMsgIdList"
			parameterType="arraylist">
		UPDATE RCV_MSG
		   SET RD_YN='Y'
		 WHERE MSG_ID IN
		 <foreach collection="list" item="msgId" open="(" close=")" separator="," >
		  #{msgId}
		 </foreach>
	</update>
</mapper>